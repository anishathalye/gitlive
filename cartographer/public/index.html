<!DOCTYPE html>
<html> 
<head> 
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
    <title>Google Maps Geocoding Demo</title> 
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <script src="http://maps.google.com/maps/api/js?libraries=visualization&sensor=true_or_false" 
        type="text/javascript"></script> 
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0px; padding: 0px }
        #map { height: 100% }
    </style>
</head> 
<body> 
    <div id="map"></div> 

    <script type="text/javascript"> 

    var map = new google.maps.Map(document.getElementById('map'), { 
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        zoom: 2,
        center: new google.maps.LatLng(40, 3)
    });

    var geocoder = new google.maps.Geocoder();

    var geocode = function(location, success) {
        geocoder.geocode({'address': location}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                success(results);
            } else {
                // ignore
            }
        });
    }

    var heatmapData = new google.maps.MVCArray();
    var heatmap = new google.maps.visualization.HeatmapLayer({
        data: heatmapData,
        radius: 25
    });
    heatmap.setMap(map);

    var source = new EventSource('/events');
    source.onmessage = function(e) {
        var event = JSON.parse(JSON.parse(e.data));
        geocode(event.location, function(results) {
            console.log(results);
            var pos = results[0].geometry.location;
            heatmapData.push(pos);
            while (heatmapData.getLength() > 16) {
                heatmapData.removeAt(0);
            }
            /*
            new google.maps.Marker({
                position: pos,
                map: map
            });
            */
            // map.setCenter(results[0].geometry.location);
        });
    };

   </script> 
</body> 
</html>
